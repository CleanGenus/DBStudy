# ğŸ“š æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–çŸ¥è¯†å¤§å…¨

> å…¨é¢çš„æ•°æ®åº“ä¼˜åŒ–æŠ€æœ¯æŒ‡å—ï¼Œæ¶µç›–ä»åŸºç¡€ç´¢å¼•åˆ°é«˜çº§è°ƒä¼˜çš„å®Œæ•´çŸ¥è¯†ä½“ç³»

## ğŸ“– ç›®å½•

- [ğŸ¯ ä¼˜åŒ–æ¦‚è¿°](#-ä¼˜åŒ–æ¦‚è¿°)
- [ğŸ“Š ç´¢å¼•ä¼˜åŒ–](#-ç´¢å¼•ä¼˜åŒ–)
- [ğŸ” æŸ¥è¯¢ä¼˜åŒ–](#-æŸ¥è¯¢ä¼˜åŒ–)
- [ğŸ—ï¸ æ•°æ®åº“ç»“æ„ä¼˜åŒ–](#ï¸-æ•°æ®åº“ç»“æ„ä¼˜åŒ–)
- [ğŸ’¾ å­˜å‚¨ä¸ç¡¬ä»¶ä¼˜åŒ–](#-å­˜å‚¨ä¸ç¡¬ä»¶ä¼˜åŒ–)
- [âš™ï¸ é…ç½®ä¼˜åŒ–](#ï¸-é…ç½®ä¼˜åŒ–)
- [ğŸ”„ å¹¶å‘ä¸é”ä¼˜åŒ–](#-å¹¶å‘ä¸é”ä¼˜åŒ–)
- [ğŸ“ˆ ç›‘æ§ä¸è¯Šæ–­](#-ç›‘æ§ä¸è¯Šæ–­)
- [ğŸš€ é«˜çº§ä¼˜åŒ–æŠ€æœ¯](#-é«˜çº§ä¼˜åŒ–æŠ€æœ¯)
- [ğŸ’» åº”ç”¨ç¨‹åºå±‚ä¼˜åŒ–](#-åº”ç”¨ç¨‹åºå±‚ä¼˜åŒ–)
- [ğŸ› ï¸ å®è·µé¡¹ç›®](#ï¸-å®è·µé¡¹ç›®)

---

## ğŸ¯ ä¼˜åŒ–æ¦‚è¿°

### æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–çš„é‡è¦æ€§

æ•°æ®åº“æ˜¯ç°ä»£åº”ç”¨ç¨‹åºçš„æ ¸å¿ƒï¼Œå…¶æ€§èƒ½ç›´æ¥å½±å“æ•´ä¸ªç³»ç»Ÿçš„å“åº”é€Ÿåº¦å’Œç”¨æˆ·ä½“éªŒã€‚éšç€æ•°æ®é‡çš„å¢é•¿ï¼Œä¼˜åŒ–å˜å¾—è¶Šæ¥è¶Šé‡è¦ï¼š

- **ç”¨æˆ·ä½“éªŒ**: æŸ¥è¯¢å“åº”æ—¶é—´ä»ç§’çº§é™è‡³æ¯«ç§’çº§
- **ç³»ç»Ÿå®¹é‡**: åŒæ ·ç¡¬ä»¶æ”¯æŒæ›´å¤šå¹¶å‘ç”¨æˆ·
- **æˆæœ¬æ§åˆ¶**: å‡å°‘ç¡¬ä»¶èµ„æºéœ€æ±‚ï¼Œé™ä½äº‘æœåŠ¡è´¹ç”¨
- **ä¸šåŠ¡å¢é•¿**: ä¸ºå¿«é€Ÿå¢é•¿çš„æ•°æ®é‡åšå¥½å‡†å¤‡

### æ€§èƒ½ä¼˜åŒ–çš„åŸºæœ¬åŸåˆ™

1. **æµ‹é‡é©±åŠ¨**: å…ˆæµ‹é‡ï¼Œå†ä¼˜åŒ–ï¼ŒåéªŒè¯
2. **ç“¶é¢ˆè¯†åˆ«**: æ‰¾åˆ°çœŸæ­£çš„æ€§èƒ½ç“¶é¢ˆ
3. **å¾ªåºæ¸è¿›**: ä»å½±å“æœ€å¤§çš„ä¼˜åŒ–å¼€å§‹
4. **æƒè¡¡å–èˆ**: è¯»å†™æ€§èƒ½ã€å­˜å‚¨ç©ºé—´ã€ç»´æŠ¤æˆæœ¬çš„å¹³è¡¡

---

## ğŸ“Š ç´¢å¼•ä¼˜åŒ–

### ç´¢å¼•åŸºç¡€çŸ¥è¯†

ç´¢å¼•æ˜¯æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–æœ€é‡è¦çš„æŠ€æœ¯ä¹‹ä¸€ï¼Œå°±åƒä¹¦çš„ç›®å½•å¸®åŠ©å¿«é€Ÿå®šä½å†…å®¹ã€‚

#### ğŸ”µ èšé›†ç´¢å¼• (Clustered Index)

```sql
-- èšé›†ç´¢å¼•å†³å®šæ•°æ®çš„ç‰©ç†å­˜å‚¨é¡ºåº
CREATE TABLE Users (
    Id INT IDENTITY(1,1) PRIMARY KEY CLUSTERED,  -- èšé›†ç´¢å¼•
    Name NVARCHAR(100),
    Email NVARCHAR(255)
);
```

**ç‰¹ç‚¹:**
- æ¯ä¸ªè¡¨åªèƒ½æœ‰ä¸€ä¸ª
- å¶å­èŠ‚ç‚¹å°±æ˜¯æ•°æ®é¡µ
- å†³å®šæ•°æ®çš„ç‰©ç†å­˜å‚¨é¡ºåº
- èŒƒå›´æŸ¥è¯¢æ€§èƒ½æœ€ä½³

**æœ€ä½³å®è·µ:**
- é€‰æ‹©çª„çš„ã€å”¯ä¸€çš„ã€ä¸ç»å¸¸å˜åŒ–çš„åˆ—
- è‡ªå¢IDé€šå¸¸æ˜¯å¥½é€‰æ‹©
- é¿å…ä½¿ç”¨GUIDç­‰å®½å­—æ®µ

#### ğŸŸ¢ éèšé›†ç´¢å¼• (Non-Clustered Index)

```sql
-- éèšé›†ç´¢å¼•æ˜¯ç‹¬ç«‹çš„ç´¢å¼•ç»“æ„
CREATE NONCLUSTERED INDEX IX_Users_Email ON Users(Email);
CREATE NONCLUSTERED INDEX IX_Users_Name_City ON Users(Name, City);  -- å¤åˆç´¢å¼•
```

**ç‰¹ç‚¹:**
- æ¯ä¸ªè¡¨å¯ä»¥æœ‰å¤šä¸ªï¼ˆæœ€å¤š999ä¸ªï¼‰
- å¶å­èŠ‚ç‚¹åŒ…å«è¡Œå®šä½ç¬¦
- ç‹¬ç«‹äºæ•°æ®å­˜å‚¨ç»“æ„
- ç²¾ç¡®æŸ¥æ‰¾æ€§èƒ½ä¼˜ç§€

### ç´¢å¼•è®¾è®¡ç­–ç•¥

#### 1. å•åˆ—ç´¢å¼•

```sql
-- é€‚ç”¨äºå•å­—æ®µæŸ¥è¯¢
CREATE INDEX IX_Users_Status ON Users(Status);
CREATE INDEX IX_Orders_OrderDate ON Orders(OrderDate);
```

**ä½¿ç”¨åœºæ™¯:**
- WHEREæ¡ä»¶ä¸­çš„å•å­—æ®µæŸ¥è¯¢
- ORDER BYå•å­—æ®µæ’åº
- å¤–é”®å­—æ®µ

#### 2. å¤åˆç´¢å¼•

```sql
-- å¤šå­—æ®µç»„åˆç´¢å¼•ï¼Œæ³¨æ„å­—æ®µé¡ºåº
CREATE INDEX IX_Users_Status_City_CreateTime ON Users(Status, City, CreateTime);
```

**å­—æ®µé¡ºåºåŸåˆ™:**
- é€‰æ‹©æ€§æœ€é«˜çš„å­—æ®µæ”¾åœ¨å‰é¢
- ç­‰å€¼æŸ¥è¯¢å­—æ®µåœ¨å‰ï¼ŒèŒƒå›´æŸ¥è¯¢å­—æ®µåœ¨å
- è€ƒè™‘æŸ¥è¯¢çš„è¿‡æ»¤é¡ºåº

**æ”¯æŒçš„æŸ¥è¯¢æ¨¡å¼:**
```sql
-- âœ… å¯ä»¥ä½¿ç”¨ç´¢å¼•
SELECT * FROM Users WHERE Status = 'Active';
SELECT * FROM Users WHERE Status = 'Active' AND City = 'Beijing';
SELECT * FROM Users WHERE Status = 'Active' AND City = 'Beijing' AND CreateTime > '2024-01-01';

-- âŒ æ— æ³•æœ‰æ•ˆä½¿ç”¨ç´¢å¼•
SELECT * FROM Users WHERE City = 'Beijing';  -- è·³è¿‡äº†ç¬¬ä¸€ä¸ªå­—æ®µ
SELECT * FROM Users WHERE CreateTime > '2024-01-01';  -- è·³è¿‡äº†å‰é¢çš„å­—æ®µ
```

#### 3. è¦†ç›–ç´¢å¼•

```sql
-- åŒ…å«æŸ¥è¯¢æ‰€éœ€çš„æ‰€æœ‰åˆ—ï¼Œé¿å…é”®æŸ¥æ‰¾
CREATE INDEX IX_Users_Status_COVERING 
ON Users(Status) 
INCLUDE (Name, Email, Phone);
```

**ä¼˜åŠ¿:**
- é¿å…é”®æŸ¥æ‰¾æ“ä½œ
- å‡å°‘I/Oæ“ä½œ
- æ˜¾è‘—æé«˜æŸ¥è¯¢æ€§èƒ½

#### 4. è¿‡æ»¤ç´¢å¼•

```sql
-- åªä¸ºæ»¡è¶³æ¡ä»¶çš„æ•°æ®å»ºç«‹ç´¢å¼•
CREATE INDEX IX_Users_Active_Salary 
ON Users(Salary) 
WHERE Status = 'Active';
```

**ä¼˜åŠ¿:**
- å‡å°‘ç´¢å¼•å¤§å°
- é™ä½ç»´æŠ¤æˆæœ¬
- æé«˜ç´¢å¼•æ•ˆç‡

#### 5. å”¯ä¸€ç´¢å¼•

```sql
-- ä¿è¯æ•°æ®å”¯ä¸€æ€§åŒæ—¶æä¾›æŸ¥è¯¢æ€§èƒ½
CREATE UNIQUE INDEX IX_Users_Email ON Users(Email);
CREATE UNIQUE INDEX IX_Users_Phone ON Users(Phone);
```

### ç´¢å¼•ä¼˜åŒ–æœ€ä½³å®è·µ

#### âœ… åº”è¯¥å»ºç´¢å¼•çš„æƒ…å†µ

1. **WHEREå­å¥ä¸­ç»å¸¸ä½¿ç”¨çš„åˆ—**
```sql
-- å¦‚æœç»å¸¸æ‰§è¡Œè¿™æ ·çš„æŸ¥è¯¢ï¼ŒStatuså­—æ®µéœ€è¦ç´¢å¼•
SELECT * FROM Users WHERE Status = 'Active';
```

2. **JOINæ¡ä»¶ä¸­çš„åˆ—**
```sql
-- UserIdå­—æ®µéœ€è¦ç´¢å¼•
SELECT u.Name, o.OrderId 
FROM Users u 
JOIN Orders o ON u.Id = o.UserId;
```

3. **ORDER BYå­å¥ä¸­çš„åˆ—**
```sql
-- CreateTimeå­—æ®µéœ€è¦ç´¢å¼•
SELECT * FROM Orders ORDER BY CreateTime DESC;
```

4. **GROUP BYå­å¥ä¸­çš„åˆ—**
```sql
-- DepartmentIdå­—æ®µéœ€è¦ç´¢å¼•
SELECT DepartmentId, COUNT(*) 
FROM Users 
GROUP BY DepartmentId;
```

#### âŒ ä¸åº”è¯¥å»ºç´¢å¼•çš„æƒ…å†µ

1. **å¾ˆå°‘æŸ¥è¯¢çš„å­—æ®µ**
2. **ç»å¸¸æ›´æ–°çš„å­—æ®µ**
3. **å°è¡¨ï¼ˆé€šå¸¸å°‘äº1000è¡Œï¼‰**
4. **é€‰æ‹©æ€§å¾ˆå·®çš„å­—æ®µ**ï¼ˆå¦‚æ€§åˆ«ï¼šåªæœ‰ç”·/å¥³ä¸¤ä¸ªå€¼ï¼‰
5. **å¾ˆå®½çš„å­—æ®µ**ï¼ˆå¦‚é•¿æ–‡æœ¬å­—æ®µï¼‰

#### ç´¢å¼•ç»´æŠ¤

```sql
-- æŸ¥çœ‹ç´¢å¼•ç¢ç‰‡
SELECT 
    i.name AS IndexName,
    ips.avg_fragmentation_in_percent,
    CASE 
        WHEN ips.avg_fragmentation_in_percent < 10 THEN 'è‰¯å¥½'
        WHEN ips.avg_fragmentation_in_percent < 30 THEN 'éœ€è¦é‡ç»„'
        ELSE 'éœ€è¦é‡å»º'
    END AS Recommendation
FROM sys.dm_db_index_physical_stats(DB_ID(), NULL, NULL, NULL, NULL) ips
JOIN sys.indexes i ON ips.object_id = i.object_id AND ips.index_id = i.index_id
WHERE i.name IS NOT NULL;

-- é‡ç»„ç´¢å¼•ï¼ˆç¢ç‰‡ç‡10-30%ï¼‰
ALTER INDEX IX_Users_Status ON Users REORGANIZE;

-- é‡å»ºç´¢å¼•ï¼ˆç¢ç‰‡ç‡>30%ï¼‰
ALTER INDEX IX_Users_Status ON Users REBUILD;

-- æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
UPDATE STATISTICS Users;
```

---

## ğŸ” æŸ¥è¯¢ä¼˜åŒ–

### SQLæŸ¥è¯¢ä¼˜åŒ–åŸºç¡€

#### 1. SELECTè¯­å¥ä¼˜åŒ–

```sql
-- âŒ é¿å…SELECT *
SELECT * FROM Users;

-- âœ… åªé€‰æ‹©éœ€è¦çš„åˆ—
SELECT Id, Name, Email FROM Users;

-- âŒ é¿å…åœ¨WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°
SELECT * FROM Users WHERE YEAR(CreateTime) = 2024;

-- âœ… ä½¿ç”¨èŒƒå›´æŸ¥è¯¢
SELECT * FROM Users WHERE CreateTime >= '2024-01-01' AND CreateTime < '2025-01-01';
```

#### 2. WHEREå­å¥ä¼˜åŒ–

```sql
-- âœ… é€‰æ‹©æ€§é«˜çš„æ¡ä»¶æ”¾åœ¨å‰é¢
SELECT * FROM Users 
WHERE Status = 'Active'  -- é€‰æ‹©æ€§é«˜
  AND City = 'Beijing'   -- é€‰æ‹©æ€§ä¸­ç­‰
  AND Age > 18;          -- é€‰æ‹©æ€§ä½

-- âœ… ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢
SELECT * FROM Users WHERE Status = @Status AND City = @City;

-- âŒ é¿å…éšå¼ç±»å‹è½¬æ¢
SELECT * FROM Users WHERE Id = '123';  -- Idæ˜¯INTç±»å‹

-- âœ… ä½¿ç”¨æ­£ç¡®çš„æ•°æ®ç±»å‹
SELECT * FROM Users WHERE Id = 123;
```

#### 3. JOINä¼˜åŒ–

```sql
-- âœ… ç¡®ä¿JOINåˆ—ä¸Šæœ‰ç´¢å¼•
CREATE INDEX IX_Orders_UserId ON Orders(UserId);
CREATE INDEX IX_Users_Id ON Users(Id);  -- é€šå¸¸ä¸»é”®å·²æœ‰

-- âœ… ä½¿ç”¨INNER JOINä»£æ›¿å­æŸ¥è¯¢
-- æ…¢æŸ¥è¯¢
SELECT * FROM Users 
WHERE Id IN (SELECT UserId FROM Orders WHERE Amount > 1000);

-- å¿«æŸ¥è¯¢
SELECT DISTINCT u.* FROM Users u
INNER JOIN Orders o ON u.Id = o.UserId
WHERE o.Amount > 1000;

-- âœ… é€‰æ‹©åˆé€‚çš„JOINç±»å‹
-- INNER JOIN: åªè¿”å›åŒ¹é…çš„è®°å½•
-- LEFT JOIN: è¿”å›å·¦è¡¨æ‰€æœ‰è®°å½•
-- RIGHT JOIN: è¿”å›å³è¡¨æ‰€æœ‰è®°å½•
-- FULL OUTER JOIN: è¿”å›æ‰€æœ‰è®°å½•
```

#### 4. å­æŸ¥è¯¢ä¼˜åŒ–

```sql
-- âŒ ç›¸å…³å­æŸ¥è¯¢ï¼ˆæ…¢ï¼‰
SELECT * FROM Users u
WHERE (SELECT COUNT(*) FROM Orders o WHERE o.UserId = u.Id) > 5;

-- âœ… JOINæ›¿ä»£å­æŸ¥è¯¢ï¼ˆå¿«ï¼‰
SELECT DISTINCT u.* FROM Users u
INNER JOIN (
    SELECT UserId FROM Orders 
    GROUP BY UserId 
    HAVING COUNT(*) > 5
) o ON u.Id = o.UserId;

-- âœ… EXISTSæ¯”INæ›´é«˜æ•ˆï¼ˆå½“å­æŸ¥è¯¢è¿”å›å¤§é‡æ•°æ®æ—¶ï¼‰
SELECT * FROM Users u
WHERE EXISTS (SELECT 1 FROM Orders o WHERE o.UserId = u.Id AND o.Amount > 1000);
```

#### 5. åˆ†é¡µæŸ¥è¯¢ä¼˜åŒ–

```sql
-- âŒ ä¼ ç»Ÿåˆ†é¡µï¼ˆæ·±åº¦åˆ†é¡µæ—¶å¾ˆæ…¢ï¼‰
SELECT * FROM Users
ORDER BY Id
OFFSET 50000 ROWS FETCH NEXT 20 ROWS ONLY;

-- âœ… æ¸¸æ ‡åˆ†é¡µï¼ˆå¿«ï¼‰
SELECT * FROM Users
WHERE Id > @LastId
ORDER BY Id
FETCH NEXT 20 ROWS ONLY;

-- âœ… ä½¿ç”¨ROW_NUMBERï¼ˆé€‚åˆå¤æ‚æ’åºï¼‰
WITH PagedUsers AS (
    SELECT *, ROW_NUMBER() OVER (ORDER BY CreateTime DESC) as RowNum
    FROM Users
    WHERE Status = 'Active'
)
SELECT * FROM PagedUsers 
WHERE RowNum BETWEEN @StartRow AND @EndRow;
```

#### 6. èšåˆæŸ¥è¯¢ä¼˜åŒ–

```sql
-- âœ… åœ¨GROUP BYåˆ—ä¸Šå»ºç«‹ç´¢å¼•
CREATE INDEX IX_Users_DepartmentId ON Users(DepartmentId);

SELECT DepartmentId, COUNT(*), AVG(Salary)
FROM Users
GROUP BY DepartmentId;

-- âœ… ä½¿ç”¨HAVINGè¿‡æ»¤åˆ†ç»„åçš„ç»“æœ
SELECT DepartmentId, COUNT(*) as UserCount
FROM Users
GROUP BY DepartmentId
HAVING COUNT(*) > 10;

-- âœ… è€ƒè™‘ä½¿ç”¨çª—å£å‡½æ•°
SELECT Name, Salary,
       ROW_NUMBER() OVER (PARTITION BY DepartmentId ORDER BY Salary DESC) as Rank
FROM Users;
```

### æŸ¥è¯¢æ€§èƒ½åˆ†æ

#### 1. æ‰§è¡Œè®¡åˆ’åˆ†æ

```sql
-- æ˜¾ç¤ºå®é™…æ‰§è¡Œè®¡åˆ’
SET STATISTICS PROFILE ON;
SELECT * FROM Users WHERE Status = 'Active';
SET STATISTICS PROFILE OFF;

-- æ˜¾ç¤ºIOç»Ÿè®¡ä¿¡æ¯
SET STATISTICS IO ON;
SELECT * FROM Users WHERE Status = 'Active';
SET STATISTICS IO OFF;

-- æ˜¾ç¤ºæ—¶é—´ç»Ÿè®¡ä¿¡æ¯
SET STATISTICS TIME ON;
SELECT * FROM Users WHERE Status = 'Active';
SET STATISTICS TIME OFF;
```

#### 2. æŸ¥è¯¢æç¤º

```sql
-- å¼ºåˆ¶ä½¿ç”¨ç‰¹å®šç´¢å¼•
SELECT * FROM Users WITH (INDEX(IX_Users_Status)) 
WHERE Status = 'Active';

-- å¼ºåˆ¶å¹¶è¡ŒæŸ¥è¯¢
SELECT * FROM Users 
WHERE Status = 'Active' 
OPTION (MAXDOP 4);

-- å¼ºåˆ¶è¡¨æ‰«æ
SELECT * FROM Users WITH (NOLOCK) 
WHERE Status = 'Active';
```

---

## ğŸ—ï¸ æ•°æ®åº“ç»“æ„ä¼˜åŒ–

### æ•°æ®åº“è®¾è®¡åŸåˆ™

#### 1. è§„èŒƒåŒ– vs åè§„èŒƒåŒ–

**è§„èŒƒåŒ–ä¼˜åŠ¿:**
- å‡å°‘æ•°æ®å†—ä½™
- ä¿è¯æ•°æ®ä¸€è‡´æ€§
- é™ä½å­˜å‚¨æˆæœ¬
- ç®€åŒ–æ•°æ®ç»´æŠ¤

**åè§„èŒƒåŒ–ä¼˜åŠ¿:**
- å‡å°‘JOINæ“ä½œ
- æé«˜æŸ¥è¯¢æ€§èƒ½
- ç®€åŒ–æŸ¥è¯¢é€»è¾‘
- é€‚åˆè¯»å¤šå†™å°‘çš„åœºæ™¯

```sql
-- è§„èŒƒåŒ–è®¾è®¡
CREATE TABLE Users (
    Id INT PRIMARY KEY,
    Name NVARCHAR(100),
    DepartmentId INT,
    FOREIGN KEY (DepartmentId) REFERENCES Departments(Id)
);

CREATE TABLE Departments (
    Id INT PRIMARY KEY,
    Name NVARCHAR(100),
    Location NVARCHAR(100)
);

-- åè§„èŒƒåŒ–è®¾è®¡ï¼ˆå†—ä½™å­˜å‚¨éƒ¨é—¨åç§°ï¼‰
CREATE TABLE Users_Denormalized (
    Id INT PRIMARY KEY,
    Name NVARCHAR(100),
    DepartmentId INT,
    DepartmentName NVARCHAR(100),  -- å†—ä½™å­—æ®µ
    DepartmentLocation NVARCHAR(100)  -- å†—ä½™å­—æ®µ
);
```

#### 2. å‚ç›´åˆ†å‰²

å°†è¡¨æŒ‰åˆ—åˆ†å‰²ï¼Œå°†å¸¸ç”¨å­—æ®µå’Œä¸å¸¸ç”¨å­—æ®µåˆ†ç¦»ï¼š

```sql
-- ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨ï¼ˆå¸¸ç”¨å­—æ®µï¼‰
CREATE TABLE UserProfiles (
    Id INT PRIMARY KEY,
    Name NVARCHAR(100),
    Email NVARCHAR(255),
    Phone NVARCHAR(50),
    CreateTime DATETIME2
);

-- ç”¨æˆ·æ‰©å±•ä¿¡æ¯è¡¨ï¼ˆä¸å¸¸ç”¨å­—æ®µï¼‰
CREATE TABLE UserExtended (
    Id INT PRIMARY KEY,
    Biography NVARCHAR(MAX),
    Photo VARBINARY(MAX),
    Preferences NVARCHAR(MAX),
    FOREIGN KEY (Id) REFERENCES UserProfiles(Id)
);
```

#### 3. æ°´å¹³åˆ†å‰²ï¼ˆåˆ†åŒºï¼‰

æŒ‰æ•°æ®ç‰¹å¾åˆ†å‰²è¡¨ï¼Œå¦‚æŒ‰æ—¶é—´ã€åœ°åŒºã€ä¸šåŠ¡ç±»å‹ç­‰ï¼š

```sql
-- æŒ‰æ—¶é—´åˆ†åŒº
CREATE PARTITION FUNCTION PF_OrderDate (DATETIME2)
AS RANGE RIGHT FOR VALUES 
('2024-01-01', '2024-04-01', '2024-07-01', '2024-10-01');

CREATE PARTITION SCHEME PS_OrderDate
AS PARTITION PF_OrderDate
TO ([PRIMARY], [PRIMARY], [PRIMARY], [PRIMARY], [PRIMARY]);

CREATE TABLE Orders_Partitioned (
    Id INT IDENTITY(1,1),
    UserId INT,
    OrderDate DATETIME2,
    Amount DECIMAL(10,2),
    CONSTRAINT PK_Orders_Partitioned PRIMARY KEY (Id, OrderDate)
) ON PS_OrderDate(OrderDate);
```

### æ•°æ®ç±»å‹ä¼˜åŒ–

#### é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹

```sql
-- âŒ æµªè´¹ç©ºé—´çš„è®¾è®¡
CREATE TABLE BadDesign (
    Id BIGINT,                    -- å¦‚æœä¸ä¼šè¶…è¿‡21äº¿ï¼Œç”¨INTå°±å¤Ÿäº†
    Name NVARCHAR(MAX),           -- åº”è¯¥é™åˆ¶é•¿åº¦
    Age INT,                      -- å¹´é¾„ç”¨TINYINTå°±å¤Ÿäº†ï¼ˆ0-255ï¼‰
    IsActive NVARCHAR(10),        -- åº”è¯¥ç”¨BIT
    Price FLOAT,                  -- é‡‘é¢åº”è¯¥ç”¨DECIMAL
    CreateDate DATETIME2(7)       -- å¦‚æœä¸éœ€è¦å¾®ç§’ç²¾åº¦ï¼Œç”¨DATETIME2(0)
);

-- âœ… ä¼˜åŒ–åçš„è®¾è®¡
CREATE TABLE GoodDesign (
    Id INT,                       -- èŠ‚çœ4å­—èŠ‚
    Name NVARCHAR(100),           -- æ˜ç¡®é•¿åº¦é™åˆ¶
    Age TINYINT,                  -- èŠ‚çœ3å­—èŠ‚
    IsActive BIT,                 -- èŠ‚çœ9å­—èŠ‚
    Price DECIMAL(10,2),          -- ç²¾ç¡®è®¡ç®—
    CreateDate DATETIME2(0)       -- èŠ‚çœ3å­—èŠ‚
);
```

#### æ•°æ®ç±»å‹é€‰æ‹©æŒ‡å—

| ç”¨é€” | æ¨èç±»å‹ | é¿å…ç±»å‹ | è¯´æ˜ |
|------|----------|----------|------|
| ä¸»é”® | INT IDENTITY | BIGINT, GUID | é™¤éç¡®å®éœ€è¦æ›´å¤§èŒƒå›´ |
| å¤–é”® | INT | BIGINT | ä¸ä¸»é”®ç±»å‹ä¿æŒä¸€è‡´ |
| å§“å | NVARCHAR(100) | NVARCHAR(MAX) | åˆç†ä¼°è®¡æœ€å¤§é•¿åº¦ |
| é‚®ç®± | VARCHAR(255) | NVARCHAR(MAX) | é‚®ç®±è§„èŒƒæœ€é•¿320å­—ç¬¦ |
| å¹´é¾„ | TINYINT | INT | 0-255èŒƒå›´è¶³å¤Ÿ |
| å¸ƒå°”å€¼ | BIT | VARCHAR | æœ€èŠ‚çœç©ºé—´ |
| é‡‘é¢ | DECIMAL(18,2) | FLOAT | é¿å…ç²¾åº¦ä¸¢å¤± |
| æ—¥æœŸ | DATE | DATETIME2 | å¦‚æœä¸éœ€è¦æ—¶é—´éƒ¨åˆ† |
| æ—¶é—´æˆ³ | DATETIME2(0) | DATETIME2(7) | ç§’çº§ç²¾åº¦é€šå¸¸å¤Ÿç”¨ |

---

## ğŸ’¾ å­˜å‚¨ä¸ç¡¬ä»¶ä¼˜åŒ–

### å­˜å‚¨ç³»ç»Ÿä¼˜åŒ–

#### 1. å­˜å‚¨ç±»å‹é€‰æ‹©

**SSD vs HDD:**
- **SSD**: éšæœºè¯»å†™æ€§èƒ½ä¼˜ç§€ï¼Œé€‚åˆOLTPç³»ç»Ÿ
- **HDD**: é¡ºåºè¯»å†™æ€§èƒ½å¥½ï¼Œæˆæœ¬ä½ï¼Œé€‚åˆå½’æ¡£æ•°æ®

**NVMe vs SATA:**
- **NVMe**: æ›´é«˜çš„IOPSå’Œæ›´ä½çš„å»¶è¿Ÿ
- **SATA**: æˆæœ¬è¾ƒä½ï¼Œæ€§èƒ½å¤Ÿç”¨

#### 2. RAIDé…ç½®

```sql
-- æŸ¥çœ‹å½“å‰å­˜å‚¨é…ç½®
SELECT 
    database_id,
    file_id,
    name,
    physical_name,
    size * 8 / 1024 AS SizeMB,
    growth,
    is_percent_growth
FROM sys.master_files
WHERE database_id = DB_ID();
```

**RAIDçº§åˆ«é€‰æ‹©:**
- **RAID 1**: æ•°æ®å®‰å…¨æ€§é«˜ï¼Œé€‚åˆæ—¥å¿—æ–‡ä»¶
- **RAID 5**: æ€§ä»·æ¯”é«˜ï¼Œé€‚åˆæ•°æ®æ–‡ä»¶
- **RAID 10**: æ€§èƒ½å’Œå®‰å…¨æ€§æœ€ä½³ï¼Œé€‚åˆé«˜è´Ÿè½½ç³»ç»Ÿ

#### 3. æ–‡ä»¶ç»„ç»‡

```sql
-- æ•°æ®æ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶åˆ†ç¦»
ALTER DATABASE MyDatabase
ADD FILEGROUP DataFileGroup;

ALTER DATABASE MyDatabase
ADD FILE (
    NAME = 'MyDatabase_Data2',
    FILENAME = 'D:\Data\MyDatabase_Data2.mdf',
    SIZE = 1024MB,
    FILEGROWTH = 256MB
) TO FILEGROUP DataFileGroup;

-- å°†è¡¨æ”¾åˆ°ç‰¹å®šæ–‡ä»¶ç»„
CREATE TABLE LargeTable (
    Id INT PRIMARY KEY,
    Data NVARCHAR(MAX)
) ON DataFileGroup;
```

### å†…å­˜ä¼˜åŒ–

#### 1. ç¼“å†²æ± ç®¡ç†

```sql
-- æŸ¥çœ‹ç¼“å†²æ± ä½¿ç”¨æƒ…å†µ
SELECT 
    counter_name,
    cntr_value
FROM sys.dm_os_performance_counters
WHERE counter_name IN (
    'Buffer cache hit ratio',
    'Page life expectancy',
    'Lazy writes/sec'
);

-- æŸ¥çœ‹å„æ•°æ®åº“å ç”¨çš„ç¼“å†²æ± 
SELECT 
    DB_NAME(database_id) AS DatabaseName,
    COUNT(*) * 8 / 1024 AS BufferSizeMB
FROM sys.dm_os_buffer_descriptors
GROUP BY database_id
ORDER BY BufferSizeMB DESC;
```

#### 2. å†…å­˜é…ç½®

```sql
-- æŸ¥çœ‹å½“å‰å†…å­˜é…ç½®
SELECT 
    name,
    value,
    value_in_use,
    description
FROM sys.configurations
WHERE name IN ('max server memory (MB)', 'min server memory (MB)');

-- è®¾ç½®æœ€å¤§æœåŠ¡å™¨å†…å­˜ï¼ˆä¸ºOSä¿ç•™è¶³å¤Ÿå†…å­˜ï¼‰
EXEC sp_configure 'max server memory (MB)', 6144;  -- 8GBç³»ç»Ÿè®¾ç½®6GB
RECONFIGURE;
```

---

## âš™ï¸ é…ç½®ä¼˜åŒ–

### SQL Serveré…ç½®ä¼˜åŒ–

#### 1. å¹¶è¡Œåº¦é…ç½®

```sql
-- æŸ¥çœ‹å½“å‰MAXDOPè®¾ç½®
SELECT name, value, value_in_use 
FROM sys.configurations 
WHERE name = 'max degree of parallelism';

-- è®¾ç½®MAXDOPï¼ˆå»ºè®®å€¼ï¼šCPUæ ¸å¿ƒæ•°çš„ä¸€åŠï¼‰
EXEC sp_configure 'max degree of parallelism', 4;
RECONFIGURE;

-- å¹¶è¡Œåº¦é˜ˆå€¼é…ç½®
EXEC sp_configure 'cost threshold for parallelism', 50;
RECONFIGURE;
```

#### 2. TempDBä¼˜åŒ–

```sql
-- æŸ¥çœ‹TempDBæ–‡ä»¶é…ç½®
SELECT 
    name,
    physical_name,
    size * 8 / 1024 AS SizeMB
FROM sys.master_files
WHERE database_id = 2;  -- TempDB

-- åˆ›å»ºå¤šä¸ªTempDBæ•°æ®æ–‡ä»¶ï¼ˆæ¨èä¸CPUæ ¸å¿ƒæ•°ç›¸ç­‰ï¼‰
ALTER DATABASE tempdb
ADD FILE (
    NAME = 'tempdev2',
    FILENAME = 'C:\TempDB\tempdev2.mdf',
    SIZE = 1024MB,
    FILEGROWTH = 256MB
);
```

#### 3. æ•°æ®åº“é…ç½®

```sql
-- è®¾ç½®æ•°æ®åº“å…¼å®¹çº§åˆ«
ALTER DATABASE MyDatabase SET COMPATIBILITY_LEVEL = 150;  -- SQL Server 2019

-- å¯ç”¨æŸ¥è¯¢å­˜å‚¨
ALTER DATABASE MyDatabase SET QUERY_STORE = ON;

-- é…ç½®è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
ALTER DATABASE MyDatabase SET AUTO_UPDATE_STATISTICS ON;
ALTER DATABASE MyDatabase SET AUTO_UPDATE_STATISTICS_ASYNC ON;

-- å¯ç”¨å¿«ç…§éš”ç¦»
ALTER DATABASE MyDatabase SET ALLOW_SNAPSHOT_ISOLATION ON;
ALTER DATABASE MyDatabase SET READ_COMMITTED_SNAPSHOT ON;
```

---

## ğŸ”„ å¹¶å‘ä¸é”ä¼˜åŒ–

### é”æœºåˆ¶ç†è§£

#### 1. é”ç±»å‹

**å…±äº«é” (S)**: è¯»å–æ•°æ®æ—¶è·å–ï¼Œå…è®¸å…¶ä»–è¯»å–
**æ’ä»–é” (X)**: ä¿®æ”¹æ•°æ®æ—¶è·å–ï¼Œé˜»æ­¢å…¶ä»–æ‰€æœ‰æ“ä½œ
**æ›´æ–°é” (U)**: è¯»å–å‡†å¤‡æ›´æ–°çš„æ•°æ®ï¼Œé˜²æ­¢æ­»é”
**æ„å‘é” (I)**: è¡¨ç¤ºä¸‹å±‚èµ„æºè¢«é”å®š

#### 2. é”ç²’åº¦

```sql
-- è¡Œçº§é”ï¼ˆé»˜è®¤ï¼Œç²’åº¦æœ€ç»†ï¼‰
SELECT * FROM Users WITH (ROWLOCK) WHERE Id = 1;

-- é¡µçº§é”
SELECT * FROM Users WITH (PAGELOCK) WHERE Status = 'Active';

-- è¡¨çº§é”
SELECT * FROM Users WITH (TABLOCKX);
```

#### 3. éš”ç¦»çº§åˆ«

```sql
-- è¯»æœªæäº¤ï¼ˆæœ€ä½éš”ç¦»çº§åˆ«ï¼‰
SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED;
SELECT * FROM Users;  -- å¯èƒ½è¯»åˆ°è„æ•°æ®

-- è¯»å·²æäº¤ï¼ˆé»˜è®¤çº§åˆ«ï¼‰
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
SELECT * FROM Users;  -- åªè¯»å·²æäº¤æ•°æ®

-- å¯é‡å¤è¯»
SET TRANSACTION ISOLATION LEVEL REPEATABLE READ;
SELECT * FROM Users WHERE Id = 1;

-- åºåˆ—åŒ–ï¼ˆæœ€é«˜éš”ç¦»çº§åˆ«ï¼‰
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
SELECT * FROM Users;

-- å¿«ç…§éš”ç¦»ï¼ˆæ¨èï¼‰
SET TRANSACTION ISOLATION LEVEL SNAPSHOT;
SELECT * FROM Users;
```

### æ­»é”é¢„é˜²ä¸è§£å†³

#### 1. æ­»é”é¢„é˜²ç­–ç•¥

```sql
-- ç»Ÿä¸€é”å®šé¡ºåº
-- âŒ å¯èƒ½å¯¼è‡´æ­»é”çš„ä»£ç 
-- äº‹åŠ¡1: å…ˆé”Aè¡¨å†é”Bè¡¨
-- äº‹åŠ¡2: å…ˆé”Bè¡¨å†é”Aè¡¨

-- âœ… ç»Ÿä¸€é”å®šé¡ºåº
BEGIN TRANSACTION;
    UPDATE Users SET Name = 'New Name' WHERE Id = 1;    -- æ€»æ˜¯å…ˆé”Usersè¡¨
    UPDATE Orders SET Amount = 1000 WHERE UserId = 1;   -- å†é”Ordersè¡¨
COMMIT;

-- ä½¿ç”¨æ›´ä½çš„éš”ç¦»çº§åˆ«
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;

-- ä½¿ç”¨NOLOCKæç¤ºï¼ˆæ³¨æ„ï¼šå¯èƒ½è¯»åˆ°è„æ•°æ®ï¼‰
SELECT * FROM Users WITH (NOLOCK) WHERE Status = 'Active';
```

#### 2. æ­»é”ç›‘æ§

```sql
-- æŸ¥çœ‹å½“å‰é˜»å¡æƒ…å†µ
SELECT 
    session_id,
    blocking_session_id,
    wait_type,
    wait_time,
    wait_resource
FROM sys.dm_exec_requests
WHERE blocking_session_id > 0;

-- æŸ¥çœ‹æ­»é”å†å²
SELECT 
    xl.resource_type,
    xl.resource_database_id,
    xl.resource_associated_entity_id,
    xl.request_mode,
    xl.request_session_id
FROM sys.dm_tran_locks xl
WHERE xl.resource_type <> 'DATABASE';
```

---

## ğŸ“ˆ ç›‘æ§ä¸è¯Šæ–­

### æ€§èƒ½ç›‘æ§

#### 1. æŸ¥è¯¢æ€§èƒ½ç›‘æ§

```sql
-- æŸ¥æ‰¾æœ€æ…¢çš„æŸ¥è¯¢
SELECT TOP 10
    qs.total_elapsed_time / qs.execution_count AS avg_elapsed_time,
    qs.total_worker_time / qs.execution_count AS avg_cpu_time,
    qs.total_logical_reads / qs.execution_count AS avg_logical_reads,
    qs.execution_count,
    SUBSTRING(st.text, (qs.statement_start_offset/2)+1,
        CASE WHEN qs.statement_end_offset = -1 
        THEN LEN(CONVERT(nvarchar(max), st.text)) * 2 
        ELSE qs.statement_end_offset END - qs.statement_start_offset)/2 + 1) AS query_text
FROM sys.dm_exec_query_stats qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) st
ORDER BY avg_elapsed_time DESC;

-- æŸ¥æ‰¾æœ€è€—CPUçš„æŸ¥è¯¢
SELECT TOP 10
    qs.total_worker_time / qs.execution_count AS avg_cpu_time,
    qs.execution_count,
    qs.total_worker_time,
    SUBSTRING(st.text, (qs.statement_start_offset/2)+1,
        CASE WHEN qs.statement_end_offset = -1 
        THEN LEN(CONVERT(nvarchar(max), st.text)) * 2 
        ELSE qs.statement_end_offset END - qs.statement_start_offset)/2 + 1) AS query_text
FROM sys.dm_exec_query_stats qs
CROSS APPLY sys.dm_exec_sql_text(qs.sql_handle) st
ORDER BY avg_cpu_time DESC;
```

#### 2. ç­‰å¾…ç»Ÿè®¡åˆ†æ

```sql
-- æŸ¥çœ‹ç­‰å¾…ç»Ÿè®¡
SELECT 
    wait_type,
    wait_time_ms,
    percentage = CAST(100.0 * wait_time_ms / SUM(wait_time_ms) OVER() AS DECIMAL(5,2)),
    avg_wait_time_ms = wait_time_ms / waiting_tasks_count
FROM sys.dm_os_wait_stats
WHERE wait_time_ms > 0
  AND wait_type NOT IN (
    'CLR_SEMAPHORE', 'LAZYWRITER_SLEEP', 'RESOURCE_QUEUE',
    'SLEEP_TASK', 'SLEEP_SYSTEMTASK', 'SQLTRACE_BUFFER_FLUSH',
    'WAITFOR', 'LOGMGR_QUEUE', 'CHECKPOINT_QUEUE'
  )
ORDER BY wait_time_ms DESC;
```

#### 3. ç´¢å¼•ä½¿ç”¨ç›‘æ§

```sql
-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨ç»Ÿè®¡
SELECT 
    OBJECT_NAME(ius.object_id) AS TableName,
    i.name AS IndexName,
    ius.user_seeks,
    ius.user_scans,
    ius.user_lookups,
    ius.user_updates,
    ius.last_user_seek,
    ius.last_user_scan
FROM sys.dm_db_index_usage_stats ius
JOIN sys.indexes i ON ius.object_id = i.object_id AND ius.index_id = i.index_id
WHERE ius.database_id = DB_ID()
ORDER BY ius.user_seeks + ius.user_scans + ius.user_lookups DESC;

-- æŸ¥æ‰¾æœªä½¿ç”¨çš„ç´¢å¼•
SELECT 
    OBJECT_NAME(i.object_id) AS TableName,
    i.name AS IndexName,
    i.type_desc
FROM sys.indexes i
LEFT JOIN sys.dm_db_index_usage_stats ius ON i.object_id = ius.object_id AND i.index_id = ius.index_id
WHERE OBJECTPROPERTY(i.object_id, 'IsUserTable') = 1
  AND i.index_id > 0
  AND ius.index_id IS NULL;
```

#### 4. ç¼ºå¤±ç´¢å¼•åˆ†æ

```sql
-- æŸ¥çœ‹ç¼ºå¤±çš„ç´¢å¼•å»ºè®®
SELECT 
    mig.index_group_handle,
    mid.index_handle,
    OBJECT_NAME(mid.object_id) AS TableName,
    migs.avg_total_user_cost * (migs.avg_user_impact / 100.0) * (migs.user_seeks + migs.user_scans) AS improvement_measure,
    'CREATE INDEX [IX_' + OBJECT_NAME(mid.object_id) + '_' + REPLACE(REPLACE(REPLACE(ISNULL(mid.equality_columns,''), ', ', '_'), '[', ''), ']', '') + 
    CASE WHEN mid.inequality_columns IS NOT NULL THEN '_' + REPLACE(REPLACE(REPLACE(mid.inequality_columns, ', ', '_'), '[', ''), ']', '') ELSE '' END + ']' +
    ' ON ' + mid.statement + ' (' + ISNULL(mid.equality_columns,'') +
    CASE WHEN mid.equality_columns IS NOT NULL AND mid.inequality_columns IS NOT NULL THEN ',' ELSE '' END +
    CASE WHEN mid.inequality_columns IS NOT NULL THEN mid.inequality_columns ELSE '' END + ')' +
    CASE WHEN mid.included_columns IS NOT NULL THEN ' INCLUDE (' + mid.included_columns + ')' ELSE '' END AS create_index_statement,
    migs.avg_user_impact,
    migs.user_seeks,
    migs.user_scans
FROM sys.dm_db_missing_index_groups mig
JOIN sys.dm_db_missing_index_group_stats migs ON mig.index_group_handle = migs.group_handle
JOIN sys.dm_db_missing_index_details mid ON mig.index_handle = mid.index_handle
WHERE mid.database_id = DB_ID()
ORDER BY improvement_measure DESC;
```

### æ€§èƒ½åŸºçº¿å»ºç«‹

#### 1. åŸºç¡€æ€§èƒ½æŒ‡æ ‡

```sql
-- å»ºç«‹æ€§èƒ½åŸºçº¿
CREATE TABLE PerformanceBaseline (
    RecordTime DATETIME2 DEFAULT GETDATE(),
    MetricName NVARCHAR(100),
    MetricValue DECIMAL(18,2),
    Unit NVARCHAR(20)
);

-- è®°å½•å…³é”®æŒ‡æ ‡
INSERT INTO PerformanceBaseline (MetricName, MetricValue, Unit)
SELECT 'Buffer Cache Hit Ratio', cntr_value, 'Percentage'
FROM sys.dm_os_performance_counters
WHERE counter_name = 'Buffer cache hit ratio';

INSERT INTO PerformanceBaseline (MetricName, MetricValue, Unit)
SELECT 'Page Life Expectancy', cntr_value, 'Seconds'
FROM sys.dm_os_performance_counters
WHERE counter_name = 'Page life expectancy';
```

---

## ğŸš€ é«˜çº§ä¼˜åŒ–æŠ€æœ¯

### åˆ—å­˜å‚¨ç´¢å¼•

```sql
-- åˆ›å»ºåˆ—å­˜å‚¨ç´¢å¼•ï¼ˆé€‚åˆåˆ†ææŸ¥è¯¢ï¼‰
CREATE COLUMNSTORE INDEX CCI_Orders ON Orders;

-- éèšé›†åˆ—å­˜å‚¨ç´¢å¼•
CREATE NONCLUSTERED COLUMNSTORE INDEX NCCI_Orders_Analytics 
ON Orders (OrderDate, UserId, Amount, Status);

-- æŸ¥è¯¢åˆ—å­˜å‚¨è¡¨
SELECT 
    YEAR(OrderDate) as OrderYear,
    COUNT(*) as OrderCount,
    SUM(Amount) as TotalAmount
FROM Orders
GROUP BY YEAR(OrderDate);
```

### å†…å­˜ä¼˜åŒ–è¡¨ (In-Memory OLTP)

```sql
-- åˆ›å»ºå†…å­˜ä¼˜åŒ–æ–‡ä»¶ç»„
ALTER DATABASE MyDatabase ADD FILEGROUP memory_optimized_data CONTAINS MEMORY_OPTIMIZED_DATA;
ALTER DATABASE MyDatabase ADD FILE (
    name='memory_optimized_data', 
    filename='C:\Data\memory_optimized_data'
) TO FILEGROUP memory_optimized_data;

-- åˆ›å»ºå†…å­˜ä¼˜åŒ–è¡¨
CREATE TABLE Users_Memory (
    Id INT NOT NULL PRIMARY KEY NONCLUSTERED HASH WITH (BUCKET_COUNT = 1000000),
    Name NVARCHAR(100) NOT NULL,
    Email NVARCHAR(255) NOT NULL,
    Status NVARCHAR(20) NOT NULL,
    CreateTime DATETIME2 NOT NULL,
    INDEX IX_Users_Memory_Status NONCLUSTERED (Status)
) WITH (MEMORY_OPTIMIZED = ON, DURABILITY = SCHEMA_AND_DATA);
```

### æ•°æ®å‹ç¼©

```sql
-- è¡Œå‹ç¼©
ALTER TABLE Users REBUILD WITH (DATA_COMPRESSION = ROW);

-- é¡µå‹ç¼©
ALTER TABLE Orders REBUILD WITH (DATA_COMPRESSION = PAGE);

-- æŸ¥çœ‹å‹ç¼©æ•ˆæœ
SELECT 
    t.name AS TableName,
    p.partition_number,
    p.data_compression_desc,
    ps.reserved_page_count,
    ps.used_page_count,
    ps.reserved_page_count * 8 / 1024 AS ReservedSpaceMB,
    ps.used_page_count * 8 / 1024 AS UsedSpaceMB
FROM sys.tables t
JOIN sys.partitions p ON t.object_id = p.object_id
JOIN sys.dm_db_partition_stats ps ON p.object_id = ps.object_id AND p.partition_id = ps.partition_id
WHERE t.name IN ('Users', 'Orders');
```

### åˆ†åŒºè¡¨

```sql
-- åˆ›å»ºåˆ†åŒºå‡½æ•°
CREATE PARTITION FUNCTION PF_Orders_Date (DATETIME2)
AS RANGE RIGHT FOR VALUES 
('2023-01-01', '2023-04-01', '2023-07-01', '2023-10-01', '2024-01-01');

-- åˆ›å»ºåˆ†åŒºæ–¹æ¡ˆ
CREATE PARTITION SCHEME PS_Orders_Date
AS PARTITION PF_Orders_Date
TO ([PRIMARY], [PRIMARY], [PRIMARY], [PRIMARY], [PRIMARY], [PRIMARY]);

-- åˆ›å»ºåˆ†åŒºè¡¨
CREATE TABLE Orders_Partitioned (
    Id INT IDENTITY(1,1),
    UserId INT,
    OrderDate DATETIME2,
    Amount DECIMAL(10,2),
    Status NVARCHAR(20),
    CONSTRAINT PK_Orders_Partitioned PRIMARY KEY (Id, OrderDate)
) ON PS_Orders_Date(OrderDate);

-- æŸ¥çœ‹åˆ†åŒºä¿¡æ¯
SELECT 
    t.name AS TableName,
    p.partition_number,
    p.rows,
    rv.value AS PartitionBoundary
FROM sys.tables t
JOIN sys.partitions p ON t.object_id = p.object_id
JOIN sys.partition_schemes ps ON p.partition_id = ps.partition_id
LEFT JOIN sys.partition_range_values rv ON ps.function_id = rv.function_id 
    AND rv.boundary_id = p.partition_number
WHERE t.name = 'Orders_Partitioned'
ORDER BY p.partition_number;
```

---

## ğŸ’» åº”ç”¨ç¨‹åºå±‚ä¼˜åŒ–

### è¿æ¥æ± ä¼˜åŒ–

```csharp
// è¿æ¥å­—ç¬¦ä¸²ä¼˜åŒ–
var connectionString = "Server=.;Database=MyDB;Integrated Security=true;" +
                      "Pooling=true;" +           // å¯ç”¨è¿æ¥æ± 
                      "Min Pool Size=5;" +        // æœ€å°è¿æ¥æ•°
                      "Max Pool Size=100;" +      // æœ€å¤§è¿æ¥æ•°
                      "Connection Timeout=30;" +  // è¿æ¥è¶…æ—¶
                      "Command Timeout=60;";      // å‘½ä»¤è¶…æ—¶

// æ­£ç¡®ä½¿ç”¨è¿æ¥
using (var connection = new SqlConnection(connectionString))
{
    connection.Open();
    // æ‰§è¡ŒæŸ¥è¯¢
} // è‡ªåŠ¨é‡Šæ”¾è¿æ¥åˆ°æ± ä¸­
```

### æ‰¹é‡æ“ä½œä¼˜åŒ–

```csharp
// âŒ ä½æ•ˆçš„å•æ¡æ’å…¥
foreach (var user in users)
{
    var sql = "INSERT INTO Users (Name, Email) VALUES (@Name, @Email)";
    await connection.ExecuteAsync(sql, user);
}

// âœ… é«˜æ•ˆçš„æ‰¹é‡æ’å…¥
using (var bulkCopy = new SqlBulkCopy(connection))
{
    bulkCopy.DestinationTableName = "Users";
    await bulkCopy.WriteToServerAsync(usersDataTable);
}

// âœ… ä½¿ç”¨Table-Valued Parameters
var sql = @"
    INSERT INTO Users (Name, Email)
    SELECT Name, Email FROM @Users";

await connection.ExecuteAsync(sql, new { Users = usersTable.AsTableValuedParameter("UserTableType") });
```

### ORMä¼˜åŒ–

```csharp
// Entity Frameworkä¼˜åŒ–ç¤ºä¾‹

// âŒ N+1æŸ¥è¯¢é—®é¢˜
var users = context.Users.ToList();
foreach (var user in users)
{
    Console.WriteLine(user.Department.Name); // æ¯æ¬¡éƒ½ä¼šæŸ¥è¯¢æ•°æ®åº“
}

// âœ… ä½¿ç”¨Includeé¢„åŠ è½½
var users = context.Users
    .Include(u => u.Department)
    .ToList();

// âœ… ä½¿ç”¨NoTrackingæé«˜æŸ¥è¯¢æ€§èƒ½
var users = context.Users
    .AsNoTracking()
    .Where(u => u.IsActive)
    .ToList();

// âœ… ä½¿ç”¨åŸç”ŸSQLå¤„ç†å¤æ‚æŸ¥è¯¢
var result = context.Database.SqlQuery<UserStatistics>(
    "SELECT DepartmentId, COUNT(*) as UserCount FROM Users GROUP BY DepartmentId"
).ToList();
```

### ç¼“å­˜ç­–ç•¥

```csharp
// åº”ç”¨ç¨‹åºç¼“å­˜
public class UserService
{
    private readonly IMemoryCache _cache;
    private readonly IUserRepository _repository;

    public async Task<User> GetUserAsync(int id)
    {
        var cacheKey = $"user_{id}";
        
        if (_cache.TryGetValue(cacheKey, out User cachedUser))
        {
            return cachedUser;
        }

        var user = await _repository.GetByIdAsync(id);
        
        _cache.Set(cacheKey, user, TimeSpan.FromMinutes(30));
        
        return user;
    }
}

// Redisåˆ†å¸ƒå¼ç¼“å­˜
public class DistributedUserService
{
    private readonly IDistributedCache _cache;
    
    public async Task<User> GetUserAsync(int id)
    {
        var cacheKey = $"user_{id}";
        var cachedUser = await _cache.GetStringAsync(cacheKey);
        
        if (cachedUser != null)
        {
            return JsonSerializer.Deserialize<User>(cachedUser);
        }
        
        var user = await _repository.GetByIdAsync(id);
        var serializedUser = JsonSerializer.Serialize(user);
        
        await _cache.SetStringAsync(cacheKey, serializedUser, 
            new DistributedCacheEntryOptions
            {
                AbsoluteExpirationRelativeToNow = TimeSpan.FromMinutes(30)
            });
        
        return user;
    }
}
```

---

## ğŸ› ï¸ å®è·µé¡¹ç›®

### æ•°æ®åº“ä¼˜åŒ–å®éªŒç¯å¢ƒ

æœ¬çŸ¥è¯†åº“é…å¥—äº†ä¸€ä¸ªå®Œæ•´çš„å®éªŒé¡¹ç›®ï¼Œä½äº`DBOptimizationStudy`ç›®å½•ï¼š

#### é¡¹ç›®ç‰¹è‰²
- ğŸ“ **6ä¸ªå®éªŒè¯¾ç¨‹**: ä»åŸºç¡€åˆ°é«˜çº§çš„å®Œæ•´å­¦ä¹ è·¯å¾„
- ğŸ“Š **ç™¾ä¸‡çº§æ•°æ®**: çœŸå®çš„å¤§æ•°æ®é‡æµ‹è¯•ç¯å¢ƒ
- ğŸš€ **æ€§èƒ½å¯¹æ¯”**: ä¼˜åŒ–å‰åçš„ç›´è§‚æ€§èƒ½å¯¹æ¯”
- ğŸ’» **å®é™…ä»£ç **: C# + SQL Serverçš„å®Œæ•´å®ç°

#### å¿«é€Ÿå¼€å§‹
```bash
cd DBOptimizationStudy
dotnet run
# é€‰æ‹© "1. ğŸ“ è¿è¡Œå®Œæ•´è¯¾ç¨‹"
```

#### å­¦ä¹ è·¯å¾„
1. **ç¯å¢ƒå‡†å¤‡**: æ•°æ®åº“åˆ›å»ºå’Œé…ç½®
2. **æ•°æ®ç”Ÿæˆ**: ç™¾ä¸‡çº§æµ‹è¯•æ•°æ®ç”Ÿæˆ
3. **åŸºå‡†æµ‹è¯•**: ä¼˜åŒ–å‰çš„æ€§èƒ½åŸºå‡†
4. **ç´¢å¼•ä¼˜åŒ–**: å„ç§ç´¢å¼•æŠ€æœ¯åº”ç”¨
5. **é«˜çº§ä¼˜åŒ–**: ä¼ä¸šçº§ä¼˜åŒ–æŠ€æœ¯
6. **æ•ˆæœéªŒè¯**: ä¼˜åŒ–å‰åæ€§èƒ½å¯¹æ¯”

### æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥æ¸…å•

#### ğŸ“‹ ç´¢å¼•ä¼˜åŒ–æ£€æŸ¥
- [ ] ä¸»é”®å’Œå¤–é”®æ˜¯å¦æœ‰ç´¢å¼•
- [ ] WHEREæ¡ä»¶å¸¸ç”¨å­—æ®µæ˜¯å¦æœ‰ç´¢å¼•
- [ ] JOINæ¡ä»¶å­—æ®µæ˜¯å¦æœ‰ç´¢å¼•
- [ ] ORDER BYå­—æ®µæ˜¯å¦æœ‰ç´¢å¼•
- [ ] æ˜¯å¦æœ‰æœªä½¿ç”¨çš„ç´¢å¼•éœ€è¦åˆ é™¤
- [ ] ç´¢å¼•ç¢ç‰‡æ˜¯å¦éœ€è¦æ•´ç†

#### ğŸ“‹ æŸ¥è¯¢ä¼˜åŒ–æ£€æŸ¥
- [ ] æ˜¯å¦é¿å…äº†SELECT *
- [ ] WHEREæ¡ä»¶æ˜¯å¦ä½¿ç”¨äº†åˆé€‚çš„æ•°æ®ç±»å‹
- [ ] æ˜¯å¦é¿å…äº†WHEREå­å¥ä¸­çš„å‡½æ•°
- [ ] JOINæ˜¯å¦ä¼˜äºå­æŸ¥è¯¢
- [ ] åˆ†é¡µæ˜¯å¦ä½¿ç”¨äº†ä¼˜åŒ–æ–¹æ¡ˆ
- [ ] æ˜¯å¦ä½¿ç”¨äº†å‚æ•°åŒ–æŸ¥è¯¢

#### ğŸ“‹ æ•°æ®åº“è®¾è®¡æ£€æŸ¥
- [ ] æ•°æ®ç±»å‹æ˜¯å¦é€‰æ‹©åˆé€‚
- [ ] æ˜¯å¦æœ‰åˆç†çš„è§„èŒƒåŒ–ç¨‹åº¦
- [ ] å¤§è¡¨æ˜¯å¦è€ƒè™‘äº†åˆ†åŒº
- [ ] æ˜¯å¦åˆ†ç¦»äº†æ•°æ®æ–‡ä»¶å’Œæ—¥å¿—æ–‡ä»¶
- [ ] TempDBæ˜¯å¦æœ‰å¤šä¸ªæ•°æ®æ–‡ä»¶

#### ğŸ“‹ é…ç½®ä¼˜åŒ–æ£€æŸ¥
- [ ] æœ€å¤§æœåŠ¡å™¨å†…å­˜æ˜¯å¦é…ç½®åˆç†
- [ ] MAXDOPæ˜¯å¦è®¾ç½®åˆé€‚
- [ ] æ˜¯å¦å¯ç”¨äº†è‡ªåŠ¨æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
- [ ] æ˜¯å¦å¯ç”¨äº†å¿«ç…§éš”ç¦»
- [ ] æ•°æ®åº“å…¼å®¹çº§åˆ«æ˜¯å¦æœ€æ–°

### æ€§èƒ½æµ‹è¯•å·¥å…·

#### 1. SQL Serverè‡ªå¸¦å·¥å…·
```sql
-- SQL Server Profiler æ›¿ä»£å“
CREATE EVENT SESSION query_performance ON SERVER
ADD EVENT sqlserver.sql_statement_completed(
    ACTION(sqlserver.sql_text, sqlserver.session_id)
    WHERE duration > 1000000  -- è¶…è¿‡1ç§’çš„æŸ¥è¯¢
);

-- æŸ¥è¯¢å­˜å‚¨
ALTER DATABASE MyDatabase SET QUERY_STORE = ON (
    OPERATION_MODE = READ_WRITE,
    DATA_FLUSH_INTERVAL_SECONDS = 900,
    INTERVAL_LENGTH_MINUTES = 60,
    MAX_STORAGE_SIZE_MB = 1000
);
```

#### 2. ç¬¬ä¸‰æ–¹å·¥å…·æ¨è
- **SQL Server Management Studio**: æ‰§è¡Œè®¡åˆ’åˆ†æ
- **Azure Data Studio**: è·¨å¹³å°æ•°æ®åº“ç®¡ç†
- **SQL Monitor**: å®æ—¶æ€§èƒ½ç›‘æ§
- **Plan Explorer**: å…è´¹çš„æ‰§è¡Œè®¡åˆ’åˆ†æå·¥å…·

---

## ğŸ“š å­¦ä¹ èµ„æºæ¨è

### ğŸ“– æ¨èä¹¦ç±
- ã€ŠSQL ServeræŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–ã€‹- æ·±å…¥ç†è§£æŸ¥è¯¢ä¼˜åŒ–
- ã€Šé«˜æ€§èƒ½SQL Serverã€‹- å…¨é¢çš„æ€§èƒ½è°ƒä¼˜æŒ‡å—
- ã€ŠSQL Serverå†…æ ¸æŠ€æœ¯ã€‹- ç†è§£SQL Serverå†…éƒ¨æœºåˆ¶
- ã€Šæ•°æ®åº“ç³»ç»Ÿæ¦‚å¿µã€‹- æ•°æ®åº“ç†è®ºåŸºç¡€

### ğŸŒ åœ¨çº¿èµ„æº
- [Microsoft Learn](https://learn.microsoft.com/sql/) - å®˜æ–¹å­¦ä¹ å¹³å°
- [SQL Server Central](https://www.sqlservercentral.com/) - ç¤¾åŒºèµ„æº
- [Brent Ozar Unlimited](https://www.brentozar.com/) - æ€§èƒ½ä¼˜åŒ–ä¸“å®¶åšå®¢
- [SQL Skills](https://www.sqlskills.com/) - æ·±åº¦æŠ€æœ¯æ–‡ç« 

### ğŸ† è®¤è¯å»ºè®®
- **Microsoft Certified: Azure Database Administrator Associate**
- **Microsoft Certified: Data Analyst Associate**
- **MCSA: SQL Server 2016 Database Administration**

---

## ğŸ¯ æ€»ç»“

æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªç³»ç»Ÿæ€§å·¥ç¨‹ï¼Œéœ€è¦ä»å¤šä¸ªç»´åº¦è¿›è¡Œè€ƒè™‘ï¼š

### ğŸ”‘ å…³é”®è¦ç‚¹
1. **ç´¢å¼•æ˜¯åŸºç¡€**: åˆç†çš„ç´¢å¼•è®¾è®¡æ˜¯æ€§èƒ½ä¼˜åŒ–çš„åŸºçŸ³
2. **æŸ¥è¯¢è¦ä¼˜åŒ–**: ç¼–å†™é«˜æ•ˆçš„SQLè¯­å¥åŒæ ·é‡è¦
3. **æ¶æ„è¦åˆç†**: å¥½çš„æ•°æ®åº“è®¾è®¡äº‹åŠåŠŸå€
4. **ç›‘æ§è¦åˆ°ä½**: æŒç»­çš„æ€§èƒ½ç›‘æ§å’Œè°ƒä¼˜
5. **å®è·µå‡ºçœŸçŸ¥**: ç†è®ºä¸å®è·µç›¸ç»“åˆ

### ğŸš€ ä¼˜åŒ–ç­–ç•¥
- **åˆ†å±‚ä¼˜åŒ–**: ä»ç¡¬ä»¶åˆ°åº”ç”¨ç¨‹åºçš„å…¨æ ˆä¼˜åŒ–
- **æ¸è¿›å¼ä¼˜åŒ–**: ä»å½±å“æœ€å¤§çš„é—®é¢˜å¼€å§‹
- **æ•°æ®é©±åŠ¨**: åŸºäºç›‘æ§æ•°æ®åšä¼˜åŒ–å†³ç­–
- **æŒç»­æ”¹è¿›**: æ€§èƒ½ä¼˜åŒ–æ˜¯ä¸€ä¸ªæŒç»­çš„è¿‡ç¨‹

### ğŸ’¡ æœ€ä½³å®è·µ
- å»ºç«‹æ€§èƒ½åŸºçº¿å’Œç›‘æ§ä½“ç³»
- å®šæœŸæ£€æŸ¥å’Œç»´æŠ¤ç´¢å¼•
- æŒç»­ä¼˜åŒ–æ…¢æŸ¥è¯¢
- åˆç†é…ç½®æ•°æ®åº“å‚æ•°
- åº”ç”¨ç¨‹åºå±‚é¢çš„ä¼˜åŒ–é…åˆ

**è®°ä½**: æ€§èƒ½ä¼˜åŒ–æ²¡æœ‰é“¶å¼¹ï¼Œéœ€è¦é’ˆå¯¹å…·ä½“åœºæ™¯åˆ¶å®šåˆé€‚çš„ç­–ç•¥ã€‚é€šè¿‡ç³»ç»Ÿæ€§çš„å­¦ä¹ å’Œå®è·µï¼Œæ‚¨å°†èƒ½å¤Ÿæ˜¾è‘—æå‡æ•°æ®åº“ç³»ç»Ÿçš„æ€§èƒ½ï¼

---

## ğŸ¤ è´¡çŒ®

æ¬¢è¿è´¡çŒ®æ›´å¤šçš„ä¼˜åŒ–æŠ€æœ¯å’Œæœ€ä½³å®è·µï¼å¦‚æœæ‚¨æœ‰å¥½çš„å»ºè®®æˆ–å‘ç°äº†é—®é¢˜ï¼Œè¯·æäº¤Issueæˆ–Pull Requestã€‚

## ğŸ“„ è®¸å¯è¯

æœ¬æ–‡æ¡£é‡‡ç”¨ MIT è®¸å¯è¯ï¼Œå¯è‡ªç”±ä½¿ç”¨å’Œåˆ†äº«ã€‚

---

**å¼€å§‹æ‚¨çš„æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–ä¹‹æ—…å§ï¼** ğŸš€

*æœ€åæ›´æ–°: 2025å¹´7æœˆ11æ—¥*
